---
import "@/styles/chiri/global.css";
import type { PostLayoutProps } from "@/types";
import FormattedDate from "@/components/chiri/widgets/FormattedDate.astro";
import FootnoteScroll from "@/components/chiri/widgets/FootnoteScroll.astro";
import BaseHead from "@/components/chiri/layout/BaseHead.astro";
import Footer from "@/components/chiri/layout/Footer.astro";
import BackButton from "@/components/chiri/ui/BackButton.astro";
import TableOfContents from "@/components/chiri/ui/TableOfContents.astro";
import GradientMask from "@/components/chiri/ui/GradientMask.astro";
import ImageOptimizer from "@/components/chiri/ui/ImageOptimizer.astro";
import ImageViewer from "@/components/chiri/ui/ImageViewer.astro";
import GitHubCard from "@/components/chiri/ui/GitHubCard.astro";
import LinkCard from "@/components/chiri/ui/LinkCard.astro";
import NeoDBCard from "@/components/chiri/ui/NeoDBCard.astro";
import XPOST from "@/components/chiri/ui/XPOST.astro";
import CopyCode from "@/components/chiri/ui/CopyCode.astro";
import BaseLayout from "@/layouts/chiri/BaseLayout.astro";

import { themeConfig } from "@/chiri-config";

const { title, pubDate, image, readingTime, toc } =
  Astro.props as PostLayoutProps;

const postSlug = Astro.url.pathname.split("/").filter(Boolean).pop() || "";
const ogImage = `/open-graph/${postSlug}.png`;
---

<BaseLayout
  title={`${title} · ${themeConfig.site.title}`}
  description={themeConfig.site.description}
  type="post"
>
  <BaseHead
    title={`${title} · ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="prose">
        <GradientMask />
        <BackButton />
        {themeConfig.post.toc && <TableOfContents toc={toc} />}
        {
          image && (
            <div class="hero-image">
              <img src={image} alt={title} />
            </div>
          )
        }
        <div class="title">
          <h1>{title}</h1>
          <div class="date">
            <FormattedDate date={pubDate} context="post" />
            {
              themeConfig.post.readingTime && readingTime && (
                <span class="reading-time">
                  <span class="separator">·</span>
                  {readingTime.text}
                </span>
              )
            }
          </div>
        </div>
        <slot />
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.imageViewer && <ImageViewer />}
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }

  .hero-image {
    margin: 0 0 2rem 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
    aspect-ratio: 21 / 9;
  }

  .hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
</style>
